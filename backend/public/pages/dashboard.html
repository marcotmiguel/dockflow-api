<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DockFlow - Dashboard</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome para √≠cones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- CSS personalizado -->
  <link rel="stylesheet" href="../assets/css/style.css">
  
  <style>
    /* Estilo espec√≠fico para o card de retornos */
    .card-retornos {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      border: none;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card-retornos:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }
    
    .card-retornos .card-body {
      padding: 1.5rem;
    }
    
    .card-retornos .display-4 {
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .card-retornos .text-white-75 {
      opacity: 0.9;
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Esconder cards quando n√£o estiver no dashboard */
    .dashboard-cards {
      display: none;
    }
    
    /* Mostrar cards apenas no dashboard */
    body.dashboard-page .dashboard-cards {
      display: flex;
    }

    /* Estilos para retornos */
    .status-aguardando { background-color: #fff3cd; border-left: 4px solid #ffc107; }
    .status-pendente { background-color: #cce7f8; border-left: 4px solid #0d6efd; }
    .status-concluido { background-color: #d4edda; border-left: 4px solid #198754; }
    .status-cancelado { background-color: #f8d7da; border-left: 4px solid #dc3545; }
    
    .retorno-item:hover {
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      transition: box-shadow 0.3s ease;
    }
  </style>
  <style>
  /* For√ßa a aba "Usu√°rios" a ficar sempre vis√≠vel */
  .sidebar .nav-item[data-role="admin"],
  nav .nav-item[data-role="admin"],
  .nav-item[data-role="admin"] {
    display: list-item !important;
    visibility: visible !important;
  }
</style>

</head>
<body>
  <!-- Alert Container CORRIGIDO -->
  <div id="alert-container" class="position-fixed" style="top: 20px; right: 20px; z-index: 9999;"></div>

  <div id="dashboard-container" class="container-fluid">
    <div class="row">
      <!-- Sidebar / Menu Lateral -->
      <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
        <div class="text-center mb-4">
          <h3 class="h5 fw-bold text-white mt-3">DockFlow</h3>
          <p class="text-white-50 small">Sistema de Gest√£o</p>
        </div>
        
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" data-page="dashboard" href="#">
              <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-page="loadings" href="#">
              <i class="fas fa-truck-loading"></i> Carregamentos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-page="retornos" href="#">
              <i class="fas fa-undo"></i> Retornos de Carga
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-page="docks" href="#">
              <i class="fas fa-warehouse"></i> Docas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-page="products" href="#">
              <i class="fas fa-box"></i> Produtos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-page="drivers" href="#">
              <i class="fas fa-id-card"></i> Motoristas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-page="vehicles" href="#">
              <i class="fas fa-truck"></i> Ve√≠culos
            </a>
          </li>
          <li class="nav-item" data-role="admin">
            <a class="nav-link" data-page="users" href="#">
              <i class="fas fa-users"></i> Usu√°rios
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-page="reports" href="#">
              <i class="fas fa-chart-bar"></i> Relat√≥rios
            </a>
          </li>
        </ul>
        
        <hr class="text-white-50">
        
        <div class="px-3 mb-3">
          <a href="#" id="logout-button" class="btn btn-outline-light btn-sm w-100">
            <i class="fas fa-sign-out-alt"></i> Sair
          </a>
        </div>
      </div>
      
      <!-- Conte√∫do Principal -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <!-- Cabe√ßalho -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2" id="page-title">Dashboard</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-user-circle me-1"></i>
                <span id="user-name">Usu√°rio</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li><a class="dropdown-item" href="#"><i class="fas fa-user me-1"></i> Perfil</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-1"></i> Configura√ß√µes</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="dropdown-logout-button"><i class="fas fa-sign-out-alt me-1"></i> Sair</a></li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Cards de Estat√≠sticas (s√≥ aparecem no dashboard) -->
        <div class="row mb-4 dashboard-cards">
          <!-- Card Carregamentos Hoje -->
          <div class="col-md-2 col-sm-6 mb-3">
            <div class="card text-white bg-primary h-100">
              <div class="card-body text-center">
                <i class="fas fa-truck-loading fa-2x mb-2"></i>
                <div class="display-6 fw-bold" id="carregamentos-hoje">0</div>
                <small class="text-white-75">Carregamentos Hoje</small>
              </div>
            </div>
          </div>
          
          <!-- Card Docas -->
          <div class="col-md-2 col-sm-6 mb-3">
            <div class="card text-white bg-success h-100">
              <div class="card-body text-center">
                <i class="fas fa-warehouse fa-2x mb-2"></i>
                <div class="display-6 fw-bold" id="docas-disponiveis">2</div>
                <small class="text-white-75">Docas Dispon√≠veis</small>
              </div>
            </div>
          </div>
          
          <!-- Card Retornos Pendentes CORRIGIDO -->
          <div class="col-md-2 col-sm-6 mb-3">
            <div class="card card-retornos h-100" onclick="irParaRetornos()" style="cursor: pointer;">
              <div class="card-body text-center">
                <i class="fas fa-undo fa-2x mb-2"></i>
                <div class="display-6 fw-bold" id="retornos-pendentes">0</div>
                <small class="text-white-75">Retornos Pendentes</small>
              </div>
            </div>
          </div>
          
          <!-- Card Retornos Aguardando NOVO -->
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card text-white bg-warning h-100">
              <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <div class="display-6 fw-bold" id="aguardando-count">0</div>
                <small class="text-white-75">Aguardando Chegada</small>
              </div>
            </div>
          </div>
          
          <!-- Card Retornos Conclu√≠dos NOVO -->
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="card text-white bg-info h-100">
              <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <div class="display-6 fw-bold" id="conferido-count">0</div>
                <small class="text-white-75">Conclu√≠dos</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Conte√∫do da p√°gina (carregado dinamicamente) -->
        <div id="content-container">
          <!-- CONTAINER DE RETORNOS ADICIONADO -->
          <div id="retornos-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-undo"></i> Retornos de Carga</h2>
              <div>
                <button class="btn btn-outline-secondary me-2" id="refresh-retornos">
                  <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#registrarRetornoModal">
                  <i class="fas fa-plus"></i> Registrar Retorno
                </button>
              </div>
            </div>
            
            <!-- Filtros -->
            <div class="row mb-3">
              <div class="col-md-4">
                <input type="text" class="form-control" id="search-retornos" placeholder="üîç Buscar por motorista ou NF...">
              </div>
              <div class="col-md-2">
                <select class="form-select" id="filter-status">
                  <option value="">Todos os Status</option>
                  <option value="aguardando_chegada">Aguardando</option>
                  <option value="pendente">Pendente</option>
                  <option value="concluido">Conclu√≠do</option>
                  <option value="cancelado">Cancelado</option>
                </select>
              </div>
            </div>
            
            <!-- Lista de Retornos - CONTAINER ESSENCIAL -->
            <div id="retornos-container">
              <!-- Os retornos ser√£o carregados aqui pelo JavaScript -->
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
  
  <!-- Modal para Novo Carregamento -->
  <div class="modal fade" id="newLoadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Novo Carregamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="new-loading-form">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="scheduled-date" class="form-label">Data</label>
                <input type="date" class="form-control" id="scheduled-date" required>
              </div>
              <div class="col-md-6">
                <label for="scheduled-time" class="form-label">Hor√°rio</label>
                <input type="time" class="form-control" id="scheduled-time" required>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Motorista</label>
              <div class="mb-2">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="driver-option" id="existing-driver" value="existing" checked>
                  <label class="form-check-label" for="existing-driver">Motorista Existente</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="driver-option" id="new-driver" value="new">
                  <label class="form-check-label" for="new-driver">Novo Motorista</label>
                </div>
              </div>
              
              <div id="existing-driver-container">
                <select class="form-select" id="driver-select">
                  <option value="">Selecione o motorista...</option>
                </select>
              </div>
              
              <div id="new-driver-container" class="d-none">
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <input type="text" class="form-control" id="driver-name" placeholder="Nome do Motorista">
                  </div>
                  <div class="col-md-6 mb-2">
                    <input type="tel" class="form-control" id="driver-phone" placeholder="Telefone (WhatsApp)">
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <input type="text" class="form-control" id="license-plate" placeholder="Placa do Ve√≠culo">
                  </div>
                  <div class="col-md-6 mb-2">
                    <input type="text" class="form-control" id="vehicle-type" placeholder="Tipo de Ve√≠culo">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Produtos</label>
              <div class="table-responsive">
                <table class="table table-sm table-hover" id="products-table">
                  <thead>
                    <tr>
                      <th>Produto</th>
                      <th width="100">Quantidade</th>
                      <th width="50"></th>
                    </tr>
                  </thead>
                  <tbody id="products-tbody">
                    <tr>
                      <td>
                        <select class="form-select product-select">
                          <option value="">Selecione o produto...</option>
                        </select>
                      </td>
                      <td>
                        <input type="number" class="form-control product-quantity" min="1" value="1">
                      </td>
                      <td>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-product">
                          <i class="fas fa-times"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="3">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-product-row">
                          <i class="fas fa-plus me-1"></i> Adicionar Produto
                        </button>
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="loading-notes" class="form-label">Observa√ß√µes</label>
              <textarea class="form-control" id="loading-notes" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="save-loading-btn">
            <span class="spinner-border spinner-border-sm d-none" id="save-loading-spinner"></span>
            <span id="save-loading-text">Salvar Carregamento</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Registrar Retorno CORRIGIDO -->
  <div class="modal fade" id="registrarRetornoModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-plus"></i> Registrar Retorno de Carga
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="registrar-retorno-form">
          <div class="modal-body">
            <div class="mb-3">
              <label for="retorno-nf" class="form-label">N√∫mero da NF *</label>
              <input type="text" class="form-control" id="retorno-nf" placeholder="NF-001" required>
            </div>
            <div class="mb-3">
              <label for="retorno-motorista" class="form-label">Nome do Motorista *</label>
              <input type="text" class="form-control" id="retorno-motorista" placeholder="Nome completo" required>
            </div>
            <div class="mb-3">
              <label for="retorno-data" class="form-label">Data de Retorno *</label>
              <input type="date" class="form-control" id="retorno-data" required>
            </div>
            <div class="mb-3">
              <label for="retorno-horario" class="form-label">Hor√°rio de Retorno</label>
              <input type="time" class="form-control" id="retorno-horario">
            </div>
            <div class="mb-3">
              <label for="retorno-total-itens" class="form-label">Total de Itens Esperados</label>
              <input type="number" class="form-control" id="retorno-total-itens" min="0" placeholder="0">
            </div>
            <div class="mb-3">
              <label for="retorno-observacoes" class="form-label">Observa√ß√µes</label>
              <textarea class="form-control" id="retorno-observacoes" rows="3" placeholder="Observa√ß√µes sobre o retorno..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save"></i> Registrar Retorno
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Bipagem de Retorno MELHORADO -->
  <div class="modal fade" id="bipagemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-barcode"></i> Bipagem de Retorno
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="retorno-info" class="mb-3"></div>
          
          <div class="row mb-3">
            <div class="col-md-8">
              <label for="codigo-item-input" class="form-label">C√≥digo do Item</label>
              <input type="text" 
                     class="form-control form-control-lg" 
                     id="codigo-item-input" 
                     placeholder="Escaneie ou digite o c√≥digo do item">
            </div>
            <div class="col-md-4">
              <label for="quantidade-input" class="form-label">Quantidade</label>
              <input type="number" 
                     class="form-control form-control-lg" 
                     id="quantidade-input" 
                     value="1" min="1">
            </div>
          </div>
          
          <div class="mb-3">
            <label for="descricao-input" class="form-label">Descri√ß√£o (Opcional)</label>
            <input type="text" 
                   class="form-control" 
                   id="descricao-input" 
                   placeholder="Descri√ß√£o do item">
          </div>
          
          <div class="d-grid gap-2 mb-3">
            <button class="btn btn-primary btn-lg" id="bipar-item-btn">
              <i class="fas fa-plus"></i> Bipar Item
            </button>
          </div>
          
          <div id="itens-bipados-container">
            <h6><i class="fas fa-list"></i> Itens Bipados</h6>
            <div id="itens-bipados-list" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
              <!-- Lista de itens ser√° inserida aqui -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Fechar
          </button>
          <button type="button" class="btn btn-success" id="finalizar-bipagem-btn">
            <i class="fas fa-check"></i> Finalizar Confer√™ncia
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Scripts JS - Ordem Importante -->
  <script src="../js/config.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/modules/utils.js"></script>
  <script src="../js/modules/dashboard.js"></script>
  <script src="../js/modules/drivers.js"></script>
  <script src="../js/modules/vehicles.js"></script>
  <script src="../js/modules/retornos-dashboard.js"></script>
  <script src="../js/main.js"></script>
  <script src="../js/modules/docks.js"></script>
  <script src="../js/modules/users.js"></script>
  
  <!-- Script para controle de p√°ginas MELHORADO -->
  <script>
    // Fun√ß√£o para remover t√≠tulos duplicados
    function removeDuplicateTitles() {
      const titles = document.querySelectorAll('h1#page-title');
      if (titles.length > 1) {
        for (let i = 1; i < titles.length; i++) {
          titles[i].remove();
        }
      }
    }
    
    // Fun√ß√£o para ir para p√°gina de retornos
    function irParaRetornos() {
      const retornosContent = document.getElementById('retornos-content');
      const contentContainer = document.getElementById('content-container');
      const pageTitle = document.getElementById('page-title');
      
      if (retornosContent && contentContainer && pageTitle) {
        // Esconder outros conte√∫dos
        const allContent = contentContainer.children;
        for (let i = 0; i < allContent.length; i++) {
          allContent[i].style.display = 'none';
        }
        
        // Mostrar conte√∫do de retornos
        retornosContent.style.display = 'block';
        pageTitle.textContent = 'Retornos de Carga';
        
        // Atualizar menu ativo
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector('[data-page="retornos"]')?.classList.add('active');
        
        // Carregar dados de retornos se dispon√≠vel
        if (window.RetornosDashboard) {
          window.RetornosDashboard.refreshData();
        }
      }
    }
    
    // Fun√ß√£o para carregar estat√≠sticas de retornos CORRIGIDA
    async function carregarEstatisticasRetornos() {
      try {
        const response = await fetch('/api/retornos/stats');
        if (response.ok) {
          const data = await response.json();
          
          if (data.success && data.data) {
            // Mapear elementos corretamente
            const mappings = [
              { id: 'retornos-pendentes', value: data.data.pendentes || 0 },
              { id: 'aguardando-count', value: data.data.aguardando_chegada || 0 },
              { id: 'conferido-count', value: data.data.concluidos || 0 }
            ];
            
            mappings.forEach(mapping => {
              const elemento = document.getElementById(mapping.id);
              if (elemento) {
                elemento.textContent = mapping.value;
                
                // Adicionar efeito pulsante se houver retornos pendentes
                if (mapping.id === 'retornos-pendentes' && mapping.value > 0) {
                  const card = elemento.closest('.card-retornos');
                  if (card) {
                    card.classList.add('pulse');
                  }
                } else if (mapping.id === 'retornos-pendentes') {
                  const card = elemento.closest('.card-retornos');
                  if (card) {
                    card.classList.remove('pulse');
                  }
                }
              }
            });
          }
        }
      } catch (error) {
        console.log('Erro ao carregar estat√≠sticas de retornos:', error);
      }
    }
    
    // Fun√ß√£o para controlar visibilidade dos cards baseado na p√°gina atual
    function controlarVisibilidadeCards() {
      const pageTitle = document.getElementById('page-title');
      if (pageTitle && pageTitle.textContent.trim() === 'Dashboard') {
        document.body.classList.add('dashboard-page');
        carregarEstatisticasRetornos();
      } else {
        document.body.classList.remove('dashboard-page');
      }
    }
    
    // Event listeners para navega√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      removeDuplicateTitles();
      controlarVisibilidadeCards();
      
      // Observar mudan√ßas no t√≠tulo da p√°gina
      const titleObserver = new MutationObserver(controlarVisibilidadeCards);
      const pageTitle = document.getElementById('page-title');
      if (pageTitle) {
        titleObserver.observe(pageTitle, { childList: true, characterData: true, subtree: true });
      }
      
      // Observar mudan√ßas no container de conte√∫do
      const contentObserver = new MutationObserver(removeDuplicateTitles);
      const contentContainer = document.getElementById('content-container');
      if (contentContainer) {
        contentObserver.observe(contentContainer, { childList: true, subtree: true });
      }
      
      // Adicionar event listener para o link de retornos
      const retornosLink = document.querySelector('[data-page="retornos"]');
      if (retornosLink) {
        retornosLink.addEventListener('click', function(e) {
          e.preventDefault();
          irParaRetornos();
        });
      }
      
      // Atualizar estat√≠sticas a cada 30 segundos (s√≥ quando no dashboard)
      setInterval(function() {
        if (document.body.classList.contains('dashboard-page')) {
          carregarEstatisticasRetornos();
        }
      }, 30000);
    });
  </script>
<script>
  function aplicarPermissoesMenu() {
    // Mostrar sempre os itens marcados como data-role="admin"
    // (ajuste tempor√°rio at√© corrigirmos o login/role)
    document.querySelectorAll('[data-role="admin"]').forEach(el => {
      el.style.display = 'list-item';
      el.hidden = false;
      el.classList.remove('d-none');
    });
  }
</script>

</body>
</html>