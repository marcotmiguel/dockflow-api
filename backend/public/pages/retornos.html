<div class="retornos-page">
  <!-- Container de alertas -->
  <div id="alert-container"></div>
  
  <!-- Estat√≠sticas dos Retornos -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
        <div class="card-body text-center">
          <i class="fas fa-hourglass-half fa-2x mb-2"></i>
          <h4 id="aguardando-count">0</h4>
          <small>Aguardando Chegada</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
        <div class="card-body text-center">
          <i class="fas fa-barcode fa-2x mb-2"></i>
          <h4 id="bipando-count">0</h4>
          <small>Bipando</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
        <div class="card-body text-center">
          <i class="fas fa-check-double fa-2x mb-2"></i>
          <h4 id="conferido-count">0</h4>
          <small>Conferido</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
        <div class="card-body text-center">
          <i class="fas fa-boxes fa-2x mb-2"></i>
          <h4 id="total-itens-retornados">0</h4>
          <small>Itens Hoje</small>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Controles dos Retornos -->
  <div class="row mb-3">
    <div class="col-md-8">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" id="refresh-retornos">
          <i class="fas fa-sync-alt"></i> Atualizar
        </button>
        <button type="button" class="btn btn-outline-success" id="registrar-retorno-btn" data-bs-toggle="modal" data-bs-target="#registrarRetornoModal">
          <i class="fas fa-plus"></i> Registrar Retorno
        </button>
      </div>
    </div>
    <div class="col-md-4">
      <div class="input-group">
        <input type="text" class="form-control" id="search-retornos" placeholder="Buscar retornos...">
        <button class="btn btn-outline-secondary" type="button">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Lista de Retornos -->
  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="fas fa-undo"></i> Retornos de Carga
      </h5>
    </div>
    <div class="card-body">
      <div id="retornos-container">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando retornos...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Estilos espec√≠ficos para retornos */
.status-aguardando { border-left: 4px solid #ffc107; }
.status-bipando { border-left: 4px solid #007bff; }
.status-conferido { border-left: 4px solid #28a745; }
.status-cancelado { border-left: 4px solid #dc3545; }

.retorno-item {
  transition: all 0.3s ease;
}

.retorno-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.barcode-input {
  font-family: 'Courier New', monospace;
  font-size: 1.1em;
}
</style>

<script>
console.log('üìÑ P√°gina retornos.html carregada');

// Fun√ß√£o para inicializar retornos
function initRetornos() {
  console.log('üîÑ Tentando inicializar retornos...');
  
  if (window.RetornosDashboard) {
    console.log('‚úÖ RetornosDashboard encontrado, inicializando...');
    window.RetornosDashboard.init();
  } else {
    console.log('‚ö†Ô∏è RetornosDashboard n√£o encontrado, criando nova inst√¢ncia...');
    
    // Tentar carregar o m√≥dulo primeiro
    if (typeof RetornosDashboard !== 'undefined') {
      window.RetornosDashboard = new RetornosDashboard();
      window.RetornosDashboard.init();
    } else {
      console.log('üì¶ Carregando dados locais diretamente...');
      // Inicializar dados locais diretamente se o m√≥dulo n√£o estiver dispon√≠vel
      loadLocalRetornosData();
    }
  }
}

// Fun√ß√£o para carregar dados locais diretamente
function loadLocalRetornosData() {
  console.log('üíæ Carregando dados locais diretamente...');
  
  // Dados de exemplo
  const retornos = [
    {
      id: 1,
      driver_name: 'Jo√£o Silva',
      driver_cpf: '12345678901',
      vehicle_plate: 'ABC1234',
      route_code: 'SP-CENTRO',
      route_description: 'S√£o Paulo Centro',
      status: 'aguardando_chegada',
      created_at: new Date().toISOString(),
      itens_retornados: null
    },
    {
      id: 2,
      driver_name: 'Maria Santos',
      driver_cpf: '98765432109',
      vehicle_plate: 'XYZ5678',
      route_code: 'SP-SUL',
      route_description: 'S√£o Paulo Zona Sul',
      status: 'bipando',
      created_at: new Date(Date.now() - 3600000).toISOString(),
      itens_retornados: '[{"codigo_barras":"123456","produto_nome":"Produto A","quantidade":1}]'
    },
    {
      id: 3,
      driver_name: 'Pedro Oliveira',
      driver_cpf: '11122233344',
      vehicle_plate: 'DEF5678',
      route_code: 'SP-NORTE',
      route_description: 'S√£o Paulo Zona Norte',
      status: 'conferido',
      created_at: new Date(Date.now() - 7200000).toISOString(),
      itens_retornados: '[{"codigo_barras":"789012","produto_nome":"Produto B","quantidade":2}]'
    }
  ];
  
  const stats = {
    aguardando_chegada: 1,
    bipando: 1,
    conferido: 1,
    total_itens_retornados: 3
  };
  
  // Atualizar estat√≠sticas
  document.getElementById('aguardando-count').textContent = stats.aguardando_chegada;
  document.getElementById('bipando-count').textContent = stats.bipando;
  document.getElementById('conferido-count').textContent = stats.conferido;
  document.getElementById('total-itens-retornados').textContent = stats.total_itens_retornados;
  
  // Renderizar retornos
  const container = document.getElementById('retornos-container');
  if (container) {
    const html = retornos.map(retorno => {
      const statusText = {
        'aguardando_chegada': 'Aguardando Chegada',
        'bipando': 'Bipando',
        'conferido': 'Conferido'
      }[retorno.status];
      
      const statusColor = {
        'aguardando_chegada': 'warning',
        'bipando': 'primary',
        'conferido': 'success'
      }[retorno.status];
      
      const statusClass = {
        'aguardando_chegada': 'status-aguardando',
        'bipando': 'status-bipando',
        'conferido': 'status-conferido'
      }[retorno.status];
      
      const itensBipados = retorno.itens_retornados ? JSON.parse(retorno.itens_retornados).length : 0;
      
      return `
        <div class="card mb-3 retorno-item ${statusClass}" data-id="${retorno.id}">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-3">
                <h6 class="mb-1">
                  <i class="fas fa-user"></i> ${retorno.driver_name}
                </h6>
                <small class="text-muted">CPF: ${retorno.driver_cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}</small>
                <br>
                <small class="text-muted">Placa: ${retorno.vehicle_plate}</small>
              </div>
              <div class="col-md-2">
                <i class="fas fa-route"></i> ${retorno.route_code}
                <br>
                <small class="text-muted">${retorno.route_description}</small>
              </div>
              <div class="col-md-2">
                <span class="badge bg-${statusColor}">
                  ${statusText}
                </span>
                <br>
                <small class="text-muted">Agora mesmo</small>
              </div>
              <div class="col-md-2">
                <i class="fas fa-boxes"></i> ${itensBipados} itens
                <br>
                <small class="text-muted">bipados</small>
              </div>
              <div class="col-md-3 text-end">
                ${retorno.status === 'aguardando_chegada' ? `
                  <button class="btn btn-sm btn-primary me-1">
                    <i class="fas fa-barcode"></i> Iniciar Bipagem
                  </button>
                  <button class="btn btn-sm btn-danger">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                ` : retorno.status === 'bipando' ? `
                  <button class="btn btn-sm btn-success me-1">
                    <i class="fas fa-barcode"></i> Continuar Bipagem
                  </button>
                  <button class="btn btn-sm btn-warning">
                    <i class="fas fa-check"></i> Finalizar
                  </button>
                ` : `
                  <small class="text-success">
                    <i class="fas fa-check-circle"></i> Conferido
                  </small>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = html;
    console.log('‚úÖ Retornos renderizados com sucesso!');
  }
}

// Tentar inicializar imediatamente
initRetornos();

// Tentar novamente ap√≥s 100ms
setTimeout(initRetornos, 100);

// E mais uma vez ap√≥s 500ms para garantir
setTimeout(initRetornos, 500);

// Tamb√©m tentar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', initRetornos);
</script>