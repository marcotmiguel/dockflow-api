<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DockFlow - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        
        .admin-container {
            background: white;
            min-height: 100vh;
            display: none;
        }
        
        .danger-zone {
            border: 2px solid #dc3545;
            border-radius: 10px;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
        }
        
        .admin-header {
            background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
            color: white;
            padding: 2rem 0;
        }
        
        .status-card {
            transition: transform 0.2s ease;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
        }
        
        .backup-item {
            border-left: 4px solid #28a745;
            background: #f8f9fa;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
        }
        
        .admin-btn {
            min-width: 150px;
            font-weight: bold;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        
        .log-viewer {
            background: #2d3748;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 5px;
        }
        
        .user-info {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .login-logo {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-danger mb-3" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <h5 id="loadingText">Processando...</h5>
            <p class="text-muted" id="loadingSubtext">Aguarde enquanto processamos sua solicitação</p>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="position-fixed" style="top: 20px; right: 20px; z-index: 9998;"></div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-shield-alt login-logo"></i>
                <h2 class="fw-bold">DockFlow Admin</h2>
                <p class="text-muted">Acesso Restrito - Apenas Desenvolvedores</p>
            </div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope me-1"></i> Email
                    </label>
                    <input type="email" class="form-control form-control-lg" id="email" 
                           placeholder="dev@dockflow.com" required>
                </div>
                
                <div class="mb-3">
                    <label for="password" class="form-label">
                        <i class="fas fa-lock me-1"></i> Senha
                    </label>
                    <input type="password" class="form-control form-control-lg" id="password" 
                           placeholder="Sua senha" required>
                </div>
                
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg" id="loginBtn">
                        <i class="fas fa-sign-in-alt me-1"></i> 
                        <span id="loginBtnText">Entrar</span>
                    </button>
                </div>
            </form>
            
            <div class="mt-4 text-center">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Credenciais padrão: dev@dockflow.com / DockFlow2025!
                </small>
            </div>
        </div>
    </div>

    <!-- Admin Container -->
    <div class="admin-container" id="adminContainer">
        <!-- Header Admin -->
        <div class="admin-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1><i class="fas fa-shield-alt"></i> Sistema de Administração DockFlow</h1>
                        <p class="mb-0">Painel de Controle Desenvolvedor - Reset e Backup do Sistema</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mt-4">
            
            <!-- User Info -->
            <div class="user-info" id="userInfo">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-1">
                            <i class="fas fa-user-shield"></i> Usuário Autenticado
                        </h6>
                        <div id="userDetails">
                            <!-- Preenchido via JavaScript -->
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-light text-dark fs-6">
                            <i class="fas fa-code"></i> DESENVOLVEDOR
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Status do Sistema -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Status do Sistema</h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="systemStatus">
                                <div class="col-md-3 mb-3">
                                    <div class="card status-card border-info">
                                        <div class="card-body text-center">
                                            <i class="fas fa-database fa-2x text-info mb-2"></i>
                                            <h6>Banco de Dados</h6>
                                            <span class="badge bg-success" id="dbStatus">Conectado</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card status-card border-primary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-table fa-2x text-primary mb-2"></i>
                                            <h6>Tabelas</h6>
                                            <span class="h5" id="tableCount">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card status-card border-warning">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-database fa-2x text-warning mb-2"></i>
                                            <h6>Total Registros</h6>
                                            <span class="h5" id="recordCount">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card status-card border-success">
                                        <div class="card-body text-center">
                                            <i class="fas fa-save fa-2x text-success mb-2"></i>
                                            <h6>Último Backup</h6>
                                            <small id="lastBackup">Nunca</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-outline-primary" onclick="loadSystemStatus()">
                                <i class="fas fa-sync-alt"></i> Atualizar Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gerenciamento de Backups -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-save"></i> Gerenciamento de Backups</h5>
                            <button class="btn btn-success admin-btn" onclick="createManualBackup()">
                                <i class="fas fa-plus"></i> Criar Backup
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="backupsList">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-sync-alt fa-spin"></i> Carregando backups...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ZONA DE PERIGO - Reset do Sistema -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="danger-zone p-4">
                        <div class="text-center mb-4">
                            <i class="fas fa-exclamation-triangle fa-4x text-danger"></i>
                            <h3 class="text-danger mt-3">⚠️ ZONA DE PERIGO ⚠️</h3>
                            <p class="text-danger fw-bold">RESET COMPLETO DO SISTEMA</p>
                        </div>
                        
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-skull-crossbones"></i> ATENÇÃO - AÇÃO IRREVERSÍVEL</h6>
                            <ul class="mb-0">
                                <li>Esta ação irá <strong>DELETAR TODOS OS DADOS</strong> do sistema</li>
                                <li>Um backup automático será criado antes da exclusão</li>
                                <li>Todas as tabelas serão <strong>COMPLETAMENTE LIMPAS</strong></li>
                                <li>Usuários desenvolvedores serão <strong>PRESERVADOS</strong></li>
                                <li>Esta operação <strong>NÃO PODE SER DESFEITA</strong></li>
                            </ul>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Confirmação de Reset:</h6>
                                <input type="text" class="form-control" id="confirmReset" 
                                       placeholder="Digite: CONFIRMAR_RESET_TOTAL">
                                <small class="text-muted">
                                    Digite exatamente: <code>CONFIRMAR_RESET_TOTAL</code>
                                </small>
                            </div>
                            <div class="col-md-6">
                                <h6>Verificação de Segurança:</h6>
                                <div class="bg-light p-3 rounded">
                                    <small>
                                        <strong>Usuário:</strong> <span id="resetUserName">-</span><br>
                                        <strong>Role:</strong> <span class="badge bg-success">DESENVOLVEDOR</span><br>
                                        <strong>Permissão:</strong> ✅ Autorizado
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-danger btn-lg admin-btn" id="resetButton" disabled 
                                    onclick="confirmSystemReset()">
                                <i class="fas fa-nuclear"></i> RESETAR SISTEMA COMPLETO
                            </button>
                            <br>
                            <small class="text-muted">
                                Botão habilitado apenas com confirmação correta
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log de Operações -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list"></i> Log de Operações</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearLog()">
                                <i class="fas fa-eraser"></i> Limpar
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="log-viewer" id="operationLog">
                                <div class="text-success">[SYSTEM] Sistema de administração inicializado</div>
                                <div class="text-info">[INFO] Aguardando comandos do usuário desenvolvedor</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação Final -->
    <div class="modal fade" id="finalConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i> CONFIRMAÇÃO FINAL
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-bomb fa-4x text-danger mb-3"></i>
                        <h4 class="text-danger">ÚLTIMA CHANCE!</h4>
                        <p class="fw-bold">
                            Você está prestes a <span class="text-danger">DELETAR TODOS OS DADOS</span> 
                            do sistema DockFlow.
                        </p>
                        <p>Esta ação é <strong>IRREVERSÍVEL</strong>!</p>
                        
                        <div class="bg-light p-3 rounded mt-3">
                            <h6>O que será feito:</h6>
                            <ol class="text-start">
                                <li>Backup automático será criado</li>
                                <li>Todas as tabelas serão limpas</li>
                                <li>Contadores serão resetados</li>
                                <li>Usuários desenvolvedores preservados</li>
                                <li>Sistema voltará ao estado inicial</li>
                            </ol>
                        </div>
                        
                        <div class="mt-3">
                            <strong>Executado por:</strong> <span id="confirmUserName">-</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="executeSystemReset()">
                        <i class="fas fa-nuclear"></i> SIM, RESETAR TUDO!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Estado global
        let currentUser = null;
        let authToken = null;
        let systemData = {};
        
        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            setupLoginForm();
            setupConfirmValidation();
            
            logOperation('SYSTEM', 'Interface de administração carregada', 'info');
        });
        
        // Verificar se usuário está autenticado
        function checkAuthStatus() {
            const token = localStorage.getItem('dockflow_admin_token');
            
            if (token) {
                authToken = token;
                validateTokenAndLoadAdmin();
            } else {
                showLoginForm();
            }
        }
        
        // Configurar formulário de login
        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleLogin();
            });
            
            // Enter nos campos
            document.getElementById('email').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('password').focus();
                }
            });
            
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        }
        
        // Handle login
        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showAlert('Preencha email e senha', 'warning');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            
            // Loading state
            loginBtn.disabled = true;
            loginBtnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Verificar se é desenvolvedor
                    if (data.data.user.role !== 'desenvolvedor') {
                        throw new Error('Acesso negado. Apenas desenvolvedores podem acessar este painel.');
                    }
                    
                    // Salvar token e dados do usuário
                    authToken = data.data.token;
                    currentUser = data.data.user;
                    
                    localStorage.setItem('dockflow_admin_token', authToken);
                    localStorage.setItem('dockflow_admin_user', JSON.stringify(currentUser));
                    
                    logOperation('SUCCESS', `Login realizado: ${currentUser.name}`, 'success');
                    
                    // Mostrar painel admin
                    showAdminPanel();
                    
                } else {
                    throw new Error(data.message || 'Erro de autenticação');
                }
                
            } catch (error) {
                console.error('Erro no login:', error);
                showAlert(error.message, 'danger');
                logOperation('ERROR', `Erro no login: ${error.message}`, 'danger');
            } finally {
                // Reset button
                loginBtn.disabled = false;
                loginBtnText.innerHTML = '<i class="fas fa-sign-in-alt me-1"></i> Entrar';
            }
        }
        
        // Validar token e carregar admin
        async function validateTokenAndLoadAdmin() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.data.role === 'desenvolvedor') {
                        currentUser = data.data;
                        showAdminPanel();
                        return;
                    }
                }
                
                // Token inválido ou usuário não é desenvolvedor
                logout();
                
            } catch (error) {
                console.error('Erro ao validar token:', error);
                logout();
            }
        }
        
        // Mostrar formulário de login
        function showLoginForm() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
        }
        
        // Mostrar painel admin
        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            
            // Atualizar informações do usuário
            updateUserInfo();
            
            // Carregar dados do sistema
            loadSystemStatus();
            loadBackups();
            
            logOperation('INFO', 'Painel administrativo carregado', 'info');
        }
        
        // Atualizar informações do usuário
        function updateUserInfo() {
            if (!currentUser) return;
            
            document.getElementById('userDetails').innerHTML = `
                <strong>${currentUser.name}</strong> (${currentUser.email})<br>
                <small class="text-light">Último login: ${currentUser.lastLogin ? new Date(currentUser.lastLogin).toLocaleString('pt-BR') : 'Primeiro acesso'}</small>
            `;
            
            document.getElementById('resetUserName').textContent = currentUser.name;
            document.getElementById('confirmUserName').textContent = currentUser.name;
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('dockflow_admin_token');
            localStorage.removeItem('dockflow_admin_user');
            
            authToken = null;
            currentUser = null;
            
            showLoginForm();
            
            // Limpar campos
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('confirmReset').value = '';
            
            logOperation('INFO', 'Logout realizado', 'info');
            showAlert('Logout realizado com sucesso', 'info');
        }
        
        // Fazer requisições autenticadas
        async function authenticatedFetch(url, options = {}) {
            if (!authToken) {
                throw new Error('Token de autenticação não encontrado');
            }
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            
            const response = await fetch(url, { ...options, headers: defaultOptions });
            
            if (response.status === 401 || response.status === 403) {
                logout();
                throw new Error('Sessão expirada. Faça login novamente.');
            }
            
            return response;
        }
        
        // Carregar status do sistema
        async function loadSystemStatus() {
            try {
                logOperation('INFO', 'Carregando status do sistema...', 'info');
                
                const response = await authenticatedFetch('/api/admin/status');
                const data = await response.json();
                
                if (data.success) {
                    systemData = data.data;
                    updateStatusDisplay(data.data);
                    logOperation('SUCCESS', 'Status do sistema carregado com sucesso', 'success');
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                logOperation('ERROR', `Erro ao carregar status: ${error.message}`, 'danger');
                showAlert('Erro ao carregar status do sistema', 'danger');
            }
        }
        
        // Atualizar display do status
        function updateStatusDisplay(status) {
            document.getElementById('dbStatus').textContent = status.database === 'connected' ? 'Conectado' : 'Desconectado';
            document.getElementById('dbStatus').className = status.database === 'connected' ? 'badge bg-success' : 'badge bg-danger';
            
            document.getElementById('tableCount').textContent = status.tables.length;
            document.getElementById('recordCount').textContent = status.totalRecords.toLocaleString();
            
            if (status.lastBackup) {
                document.getElementById('lastBackup').innerHTML = `
                    ${status.lastBackup.createdFormatted}<br>
                    <small>${status.lastBackup.sizeFormatted}</small>
                `;
            } else {
                document.getElementById('lastBackup').textContent = 'Nunca';
            }
        }
        
        // Carregar lista de backups
        async function loadBackups() {
            try {
                const response = await authenticatedFetch('/api/admin/backups');
                const data = await response.json();
                
                if (data.success) {
                    displayBackups(data.data);
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                console.error('Erro ao carregar backups:', error);
                document.getElementById('backupsList').innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Erro ao carregar backups: ${error.message}
                    </div>
                `;
            }
        }
        
        // Exibir lista de backups
        function displayBackups(backups) {
            const container = document.getElementById('backupsList');
            
            if (backups.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                        <p>Nenhum backup encontrado</p>
                        <small>Clique em "Criar Backup" para fazer o primeiro backup</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            backups.forEach(backup => {
                html += `
                    <div class="backup-item">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-1">
                                    <i class="fas fa-file-archive text-success"></i> 
                                    ${backup.fileName}
                                </h6>
                                <small class="text-muted">${backup.createdFormatted}</small>
                            </div>
                            <div class="col-md-3">
                                <span class="badge bg-info">${backup.sizeFormatted}</span>
                            </div>
                            <div class="col-md-3 text-end">
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="downloadBackup('${backup.fileName}')" 
                                        title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Configurar validação da confirmação
        function setupConfirmValidation() {
            const confirmInput = document.getElementById('confirmReset');
            
            confirmInput.addEventListener('input', function() {
                checkResetButton();
            });
        }
        
        // Verificar se botão de reset pode ser habilitado
        function checkResetButton() {
            const confirm = document.getElementById('confirmReset').value;
            const resetButton = document.getElementById('resetButton');
            
            const confirmValid = confirm === 'CONFIRMAR_RESET_TOTAL';
            const userValid = currentUser && currentUser.role === 'desenvolvedor';
            
            resetButton.disabled = !(confirmValid && userValid);
            
            if (confirmValid && userValid) {
                resetButton.classList.remove('btn-danger');
                resetButton.classList.add('btn-warning');
                resetButton.innerHTML = '<i class="fas fa-nuclear"></i> PRONTO PARA RESET!';
            } else {
                resetButton.classList.remove('btn-warning');
                resetButton.classList.add('btn-danger');
                resetButton.innerHTML = '<i class="fas fa-nuclear"></i> RESETAR SISTEMA COMPLETO';
            }
        }
        
        // Criar backup manual
        async function createManualBackup() {
            try {
                showLoading('Criando backup...', 'Salvando dados do sistema');
                logOperation('BACKUP', 'Iniciando criação de backup manual...', 'info');
                
                const response = await authenticatedFetch('/api/admin/backup', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logOperation('SUCCESS', `Backup criado: ${data.data.fileName}`, 'success');
                    logOperation('INFO', `Total de registros: ${data.data.totalRecords}`, 'info');
                    showAlert('Backup criado com sucesso!', 'success');
                    loadSystemStatus();
                    loadBackups();
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                logOperation('ERROR', `Erro ao criar backup: ${error.message}`, 'danger');
                showAlert(`Erro ao criar backup: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        }
        
        // Confirmar reset do sistema
        function confirmSystemReset() {
            const modal = new bootstrap.Modal(document.getElementById('finalConfirmModal'));
            modal.show();
            
            logOperation('WARNING', 'Usuário solicitou confirmação de reset', 'warning');
        }
        
        // Executar reset do sistema
        async function executeSystemReset() {
            try {
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('finalConfirmModal'));
                modal.hide();
                
                showLoading('Executando Reset...', 'ATENÇÃO: Deletando todos os dados do sistema');
                logOperation('DANGER', 'INICIANDO RESET COMPLETO DO SISTEMA', 'danger');
                
                const response = await authenticatedFetch('/api/admin/reset', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        confirm_reset: 'CONFIRM_RESET_ALL_DATA'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logOperation('SUCCESS', 'RESET COMPLETO EXECUTADO COM SUCESSO!', 'success');
                    logOperation('INFO', `Backup criado: ${data.data.backup.fileName}`, 'info');
                    logOperation('INFO', `Registros deletados: ${data.data.reset.totalDeleted}`, 'info');
                    logOperation('INFO', `Executado por: ${data.data.executedBy.name}`, 'info');
                    
                    showAlert('Sistema resetado com sucesso! Backup criado automaticamente.', 'success');
                    
                    // Limpar campos
                    document.getElementById('confirmReset').value = '';
                    checkResetButton();
                    
                    // Recarregar status
                    setTimeout(() => {
                        loadSystemStatus();
                        loadBackups();
                    }, 2000);
                    
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                logOperation('ERROR', `ERRO NO RESET: ${error.message}`, 'danger');
                showAlert(`Erro no reset: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        }
        
        // Download backup (placeholder)
        function downloadBackup(fileName) {
            showAlert('Funcionalidade de download em desenvolvimento', 'info');
            logOperation('INFO', `Solicitado download: ${fileName}`, 'info');
        }
        
        // Mostrar loading
        function showLoading(title, subtitle) {
            document.getElementById('loadingText').textContent = title;
            document.getElementById('loadingSubtext').textContent = subtitle;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        // Esconder loading
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Log de operações
        function logOperation(type, message, alertType = 'info') {
            const log = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            
            const colors = {
                'info': 'text-info',
                'success': 'text-success', 
                'warning': 'text-warning',
                'danger': 'text-danger'
            };
            
            const colorClass = colors[alertType] || 'text-light';
            
            const logEntry = document.createElement('div');
            logEntry.className = colorClass;
            logEntry.innerHTML = `[${timestamp}] [${type}] ${message}`;
            
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }
        
        // Limpar log
        function clearLog() {
            document.getElementById('operationLog').innerHTML = '';
            logOperation('SYSTEM', 'Log de operações limpo', 'info');
        }
        
        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alert = document.createElement('div');
            alert.id = alertId;
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>